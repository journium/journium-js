<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Monitor</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .connected { background-color: #4CAF50; }
        .disconnected { background-color: #f44336; }
        .events-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .events-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .clear-btn:hover {
            background: #c82333;
        }
        .events-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .event-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.3s;
        }
        .event-item:hover {
            background-color: #f8f9fa;
        }
        .event-item:last-child {
            border-bottom: none;
        }
        .event-timestamp {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .event-data {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .no-events {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-input {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Event Monitor Dashboard</h1>
            <p>Real-time monitoring of ingested events via WebSocket</p>
        </div>

        <div class="status">
            <div class="status-item">
                <strong>Connection Status:</strong>
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">Connecting...</span>
            </div>
            <div class="status-item">
                <strong>Events Received:</strong>
                <span id="eventCount">0</span>
            </div>
            <div class="status-item">
                <strong>Last Event:</strong>
                <span id="lastEventTime">Never</span>
            </div>
        </div>

        <div class="test-section">
            <h3>Test Event Ingestion</h3>
            <textarea 
                id="testData" 
                class="test-input" 
                placeholder='{"message": "Hello World", "type": "test", "value": 42}'
            >{"message": "Hello World", "type": "test", "value": 42}</textarea>
            <br>
            <button class="test-btn" onclick="sendTestEvent()">Send Test Event</button>
        </div>

        <div class="events-container">
            <div class="events-header">
                <h3>Live Events Stream</h3>
                <button class="clear-btn" onclick="clearEvents()">Clear Events</button>
            </div>
            <div class="events-list" id="eventsList">
                <div class="no-events">
                    No events received yet. Send a POST request to /v1/ingest_event to see events here.
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let eventCount = 0;
        const maxEvents = 100;

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                updateConnectionStatus(true);
                console.log('WebSocket connected');
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addEvent(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            ws.onclose = function() {
                updateConnectionStatus(false);
                console.log('WebSocket disconnected, attempting to reconnect...');
                setTimeout(connect, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'Connected';
            } else {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        function addEvent(data) {
            eventCount++;
            document.getElementById('eventCount').textContent = eventCount;
            document.getElementById('lastEventTime').textContent = new Date(data.timestamp).toLocaleString();

            const eventsList = document.getElementById('eventsList');
            const noEventsMsg = eventsList.querySelector('.no-events');
            if (noEventsMsg) {
                noEventsMsg.remove();
            }

            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `
                <div class="event-timestamp">${new Date(data.timestamp).toLocaleString()}</div>
                <div class="event-data">${JSON.stringify(data.event, null, 2)}</div>
            `;

            eventsList.insertBefore(eventItem, eventsList.firstChild);

            if (eventsList.children.length > maxEvents) {
                eventsList.removeChild(eventsList.lastChild);
            }

            eventItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function clearEvents() {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '<div class="no-events">Events cleared. Send a POST request to /v1/ingest_event to see new events here.</div>';
            eventCount = 0;
            document.getElementById('eventCount').textContent = '0';
            document.getElementById('lastEventTime').textContent = 'Never';
        }

        async function sendTestEvent() {
            const testData = document.getElementById('testData').value;
            try {
                const data = JSON.parse(testData);
                const response = await fetch('/v1/ingest_event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    console.log('Test event sent successfully');
                } else {
                    console.error('Failed to send test event:', response.statusText);
                }
            } catch (error) {
                alert('Invalid JSON format. Please check your test data.');
                console.error('Error sending test event:', error);
            }
        }

        connect();
    </script>
</body>
</html>