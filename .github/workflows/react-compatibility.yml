name: React Version Compatibility Tests

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'packages/journium-react/**'
      - '.github/workflows/react-compatibility.yml'
  pull_request:
    paths:
      - 'packages/journium-react/**'
      - '.github/workflows/react-compatibility.yml'
  workflow_dispatch: # Allow manual triggering

jobs:
  test-compatibility:
    name: Test React ${{ matrix.react-version }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false # Continue testing other versions even if one fails
      matrix:
        react-version:
          - '16.8.0'
          - '16.14.0'
          - '17.0.2'
          - '18.0.0'
          - '18.2.0'
          - '18.3.1'
        node-version: [18.x]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: |
          pnpm --filter @journium/core build
          pnpm --filter @journium/js build
          pnpm --filter @journium/react build

      - name: Create test environment
        run: |
          mkdir -p /tmp/react-compat-test
          cd /tmp/react-compat-test
          npm init -y
          
      - name: Install React ${{ matrix.react-version }}
        run: |
          cd /tmp/react-compat-test
          
          # Determine type versions based on React version
          if [[ "${{ matrix.react-version }}" == 16.* ]]; then
            TYPES_REACT="16.14.0"
            TYPES_REACT_DOM="16.9.0"
            TESTING_LIBRARY="9.5.0"
          elif [[ "${{ matrix.react-version }}" == 17.* ]]; then
            TYPES_REACT="17.0.0"
            TYPES_REACT_DOM="17.0.0"
            TESTING_LIBRARY="12.1.5"
          else
            TYPES_REACT="18.0.0"
            TYPES_REACT_DOM="18.0.0"
            TESTING_LIBRARY="13.4.0"
          fi
          
          # Install all dependencies in a single command to avoid peer dependency issues
          npm install \
            react@${{ matrix.react-version }} \
            react-dom@${{ matrix.react-version }} \
            --save
          
          npm install \
            @types/react@${TYPES_REACT} \
            @types/react-dom@${TYPES_REACT_DOM} \
            @testing-library/react@${TESTING_LIBRARY} \
            @testing-library/jest-dom@5.16.5 \
            typescript@4.9.5 \
            ts-jest@29.0.0 \
            jest@29.0.0 \
            jest-environment-jsdom@29.0.0 \
            --save-dev \
            --legacy-peer-deps

      - name: Pack and install @journium/react
        run: |
          cd ${{ github.workspace }}/packages/journium-react
          PACKAGE_FILE=$(npm pack 2>&1 | tail -n 1)
          cd /tmp/react-compat-test
          npm install ${{ github.workspace }}/packages/journium-react/$PACKAGE_FILE
          rm ${{ github.workspace }}/packages/journium-react/$PACKAGE_FILE

      - name: Copy test suite
        run: |
          cp -r ${{ github.workspace }}/packages/journium-react/test-compat/test-suite /tmp/react-compat-test/tests

      - name: Create Jest config
        run: |
          cd /tmp/react-compat-test
          cat > jest.config.js <<EOF
          module.exports = {
            preset: 'ts-jest',
            testEnvironment: 'jsdom',
            roots: ['<rootDir>/tests'],
            testMatch: ['**/*.test.tsx'],
            setupFilesAfterEnv: ['<rootDir>/tests/setup.ts'],
            moduleNameMapper: {
              '^@journium/react\$': '<rootDir>/node_modules/@journium/react'
            },
            globals: {
              'ts-jest': {
                tsconfig: {
                  jsx: 'react',
                  esModuleInterop: true,
                  allowSyntheticDefaultImports: true,
                  module: 'commonjs',
                  target: 'es2017'
                }
              }
            }
          };
          EOF

      - name: Run compatibility tests
        run: |
          cd /tmp/react-compat-test
          npm test -- --verbose

      - name: Report success
        if: success()
        run: |
          echo "✅ @journium/react is compatible with React ${{ matrix.react-version }}"

      - name: Report failure
        if: failure()
        run: |
          echo "❌ @journium/react has compatibility issues with React ${{ matrix.react-version }}"
          exit 1

  compatibility-summary:
    name: Compatibility Test Summary
    runs-on: ubuntu-latest
    needs: test-compatibility
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.test-compatibility.result }}" == "success" ]]; then
            echo "✅ All React version compatibility tests passed!"
            exit 0
          else
            echo "❌ Some React version compatibility tests failed"
            echo "Check the individual test jobs for details"
            exit 1
          fi

      - name: Post summary
        if: always()
        run: |
          echo "## React Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| React Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # This will be populated by the matrix results
          if [[ "${{ needs.test-compatibility.result }}" == "success" ]]; then
            echo "| All Versions | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Some Versions | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested versions: 16.8.0, 16.14.0, 17.0.2, 18.0.0, 18.2.0, 18.3.1" >> $GITHUB_STEP_SUMMARY
